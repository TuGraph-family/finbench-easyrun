FROM tugraph/tugraph-compile-centos7:latest

ARG JFLAG=-j48

RUN yum install -y vim
RUN cd /root/ && mkdir .m2 data ldbc tugraph /data

# copy datasets and projects
COPY datasets /root/data/
COPY maven-settings.xml /root/.m2/settings.xml
COPY deps/ldbc_finbench_driver /root/ldbc/
COPY deps/ldbc_finbench_transaction_impls /root/ldbc/
COPY deps/tugraph-db /root/tugraph/

# install tugraph
RUN cd /root/tugraph/tugraph-db && mkdir build && cd build \
     && cmake .. -DCMAKE_BUILD_TYPE=Coverage && make install ${JFLAG}
# compile benchmark suite
RUN cd /root/ldbc/ldbc_finbench_driver && mvn clean install \
     && cd /root/ldbc/ldbc_finbench_transaction_impls/tugraph \
     && mvn clean package
# load sf1 data
RUN cd /root/ldbc/ldbc_finbench_transaction_impls/tugraph/data \
     && tar zxf /root/data/datasets/sf1.tar.gz \
     && find . | egrep "._" | xargs rm \
     && cd sf1 && unzip /root/data/datasets/sf1_read_params.zip \
     && rm -rf __MACOSX && mv sf1_read_params read_params \
     && bash ../scripts/convert_data.sh sf1 \
     && bash ../scripts/load_data.sh sf1 \
     && cd /data/ && mv lgraph_db lgraph_db_sf1

# load sf10 data
RUN cd /root/ldbc/ldbc_finbench_transaction_impls/tugraph/data \
     && tar zxf /root/data/datasets/sf10.tar.gz \
     && find . | egrep "._" | xargs rm \
     && cd sf10 && unzip /root/data/datasets/sf10_read_params.zip \
     && rm -rf __MACOSX && mv sf10_read_params read_params \
     && bash ../scripts/convert_data.sh sf10 \
     && bash ../scripts/load_data.sh sf10 \
     && cd /data/ && mv lgraph_db lgraph_db_sf10

# start lgraph server and load procedures
RUN lgraph_server --directory /data/lgraph_db_sf1 --log_dir /data/lgraph_log -d start \
     && bash /root/ldbc/ldbc_finbench_transaction_impls/tugraph/scripts/build_procedure.sh \
     && bash /root/ldbc/ldbc_finbench_transaction_impls/tugraph/scripts/load_procedure.sh

RUN cd /root/ldbc/ldbc_finbench_transaction_impls/tugraph/ \
     && cp /root/data/datasets/validation_params.csv.sf1.20230605 validation_params.csv \
     && sed -i 's/172.21.189.228/127.0.0.1/g'  validate_database.properties \
     && sed -i 's/172.21.189.228/127.0.0.1/g'  benchmark.properties
